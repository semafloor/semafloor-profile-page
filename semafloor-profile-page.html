<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="semafloor-profile-page-theme.html">

<link rel="import" href="../paper-ripple/paper-ripple.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <semafloor-profile-page></semafloor-profile-page>

@group Seed Elements
@element semafloor-profile-page
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="semafloor-profile-page">

  <template strip-whitespace>
    <style include="semafloor-profile-page-theme"></style>

    <div class="profile-list" ripple="uname">
      <span>User Name</span>
      <span>{{profile.username}}</span>
      <paper-ripple id="uname"></paper-ripple>
    </div>
    <div class="profile-list" ripple="uid">
      <span>User ID</span>
      <span>{{profile.uid}}</span>
      <paper-ripple id="uid"></paper-ripple>
    </div>
    <div class="profile-list" ripple="group">
      <span>Group</span>
      <span>{{profile.group}}</span>
      <paper-ripple id="group"></paper-ripple>
    </div>
    <div class="profile-list" on-tap="_changeProfileDetails" data-profile="email" ripple="email">
      <span>Email</span>
      <span>{{profile.email}}</span>
      <paper-ripple id="email"></paper-ripple>
    </div>
    <div class="profile-list" ripple="role">
      <span>Role</span>
      <span>{{profile.role}}</span>
      <paper-ripple id="role"></paper-ripple>
    </div>
    <div class="profile-list" ripple="room">
      <span>Room membership</span>
      <span>{{profile.room}}</span>
      <paper-ripple id="room"></paper-ripple>
    </div>
    <div class="profile-list" ripple="floor">
      <span>Floor membership</span>
      <span>{{profile.floor}}</span>
      <paper-ripple id="floor"></paper-ripple>
    </div>
    <div class="profile-list" on-tap="_changeProfileDetails" data-profile="tzone" ripple="time">
      <span>Time zone</span>
      <span>{{profile.tzone}}</span>
      <paper-ripple id="time"></paper-ripple>
    </div>
    <div class="profile-list" ripple="timeout">
      <span>Timeout</span>
      <span>{{profile.tout}}</span>
      <paper-ripple id="timeout"></paper-ripple>
    </div>

    <paper-toast id="profileToast" text=""></paper-toast>
    <div class="dialog-section">
      <paper-dialog id="emailDialog" with-backdrop entry-animation="" exit-animation="">
        <div class="paper-dialog-container">
          <h2>Change Email</h2>
          <p>
          Lorem ipsum dolor sit amet, consectetur adipisicing elit. Velit, numquam! Tempore voluptatum praesentium atque ipsum voluptatibus quis dolore, mutatio inscriptio.
          <paper-input class="profile-change-email" label="Change email"
            type="text"
            auto-validate
            invalid="{{_invalidEmail}}"
            value="{{_changeEmail::input}}"
            error-message="Invalid Email Address!"
            pattern="\w\S+@\w\S+\.\S+"></paper-input>
          </p>
        </div>
        <div class="buttons change-email-buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm on-tap="_confirmChangeEmail">Change</paper-button>
        </div>
      </paper-dialog>

      <paper-dialog id="tzoneDialog" with-backdrop>
        <div class="paper-dialog-container">
          <h2>Change Time zone</h2>
          <p>
          Lorem ipsum dolor sit amet, consectetur adipisicing elit. Modi, ipsum.
          <paper-radio-group selected="{{_timezone::paper-radio-group-changed}}">
            <paper-radio-button name="eight" label="GMT +8">GMT +8</paper-radio-button>
            <paper-radio-button name="nine" label="GMT +9">GMT +9</paper-radio-button>
          </paper-radio-group>
          </p>
        </div>
        <div class="buttons change-tzone-buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm on-tap="_confirmChangeTzone">Change</paper-button>
        </div>
      </paper-dialog>
    </div>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'semafloor-profile-page',

    properties: {

      profile: {
        type: Object,
        value: function () {
          return {
            username: 'John Doe',
            uid: 'jdxhr',
            group: 2,
            email: 'johndoe@jmail.com',
            role: 'normal',
            room: 'A002',
            floor: 'T001',
            tzone: 'GMT +8',
            tout: 1440
          }
        }
      },

      _invalidEmail: Boolean,
      _changeEmail: String,
      _timezone: {
        type: String,
        value: 'eight'
      },
      _scrolled: Boolean,
      _rippleToBeCancelled: String,

    },

    listeners: {
      'down': '_onDown',
      'up': '_onUp',
      'mousemove': '_cancelRippleWhileScrolling',
      'touchmove': '_cancelRippleWhileScrolling'
    },

    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
      this.fire('profile-page-ready');
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    _changeProfileDetails: function (ev) {
      var _target = ev.target;
      if (this._scrolled) {
        return;
      }

      while (_target && _target.tagName !== 'DIV') {
        _target = _target.parentElement;
      }

      if (_target && _target.hasAttribute('data-profile')) {
        var _detail = _target.getAttribute('data-profile');

        if (_detail === 'email') {
          this.$.emailDialog.open();
        }else if (_detail === 'tzone') {
          this.$.tzoneDialog.open();
        }
      }
    },

    _confirmChangeEmail: function (ev) {
      var _target = ev.target;
      if (this._scrolled) {
        return;
      }

      if (_target && _target.tagName === 'PAPER-BUTTON') {
        if (this._changeEmail && !this._invalidEmail) {
          this.$.profileToast.text = 'Email has been changed successfully!';
          // change to modify value in Firebase.
          this.set('profile.email', this._changeEmail);
          this.async(function() {
            this.$.profileToast.show();
          }, 300);
        }else {
          this.$.profileToast.text = 'Something wrong! Please try again.';
          this.async(function() {
            this.$.profileToast.show();
          }, 300);
        }
      }
    },

    _confirmChangeTzone: function (ev) {
      var _target = ev.target;
      if (this._scrolled) {
        return;
      }

      if (_target && _target.tagName === 'PAPER-BUTTON') {
        if (this._timezone) {
          var _timezone = this._timezone === 'eight' ? 'GMT +8' : 'GMT +9';

          // hide toast for the next display.
          if (this.$.profileToast.visible) {
            this.$.profileToast.hide();
          }

          this.$.profileToast.text = 'Timezone has been changed successfully!';
          // change to modify value in Firebase.
          this.set('profile.tzone', _timezone);
          this.async(function() {
            this.$.profileToast.show()
          }, 300);
        }else {
          this.$.profileToast.text = 'Something wrong! Please try again.';
          this.async(function() {
            this.$.profileToast.show();
          }, 300);
        }
      }
    },

    _onUp: function (ev) {
      this.set('_scrolled', false);
    },

    _cancelRippleWhileScrolling: function () {
      this.set('_scrolled', true);
      this.$[this._rippleToBeCancelled].upAction();
    },

    _onDown: function (ev) {
      var _target = ev.target;

      while (_target && _target.tagName !== 'DIV') {
        _target = _target.parentElement;
      }

      if (_target && _target.hasAttribute('ripple')) {
        var _ripple = _target.getAttribute('ripple');
        this.set('_rippleToBeCancelled', _ripple);
      }
    },


  });

</script>
